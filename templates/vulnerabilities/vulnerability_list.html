{% extends 'base.html' %}

{% block title %}Vulnerabilities - Vulnerability Management System{% endblock %}

{% block extra_css %}
<style>
    .floating-chat-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #4CAF50;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .floating-chat-btn:hover {
        background-color: #45a049;
        transform: scale(1.1);
    }

    .floating-chat-btn i {
        font-size: 24px;
    }

    /* Chat icon */
    .chat-icon {
        width: 24px;
        height: 24px;
        position: relative;
    }

    .chat-icon:before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 16px;
        border-radius: 3px;
        background-color: white;
    }

    .chat-icon:after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 8px;
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 8px solid white;
    }

    /* Chat modal */
    .chat-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .chat-modal-content {
        background-color: white;
        width: 80%;
        max-width: 800px;
        height: 80%;
        border-radius: 5px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .chat-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .chat-modal-title {
        margin: 0;
        font-size: 1.25rem;
    }

    .chat-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
    }

    .chat-modal-body {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Chat styles */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f9f9f9;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        max-width: 80%;
    }

    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        border-top-right-radius: 0;
    }

    .assistant-message {
        background-color: #f1f1f1;
        margin-right: auto;
        border-top-left-radius: 0;
    }

    .message-content {
        word-wrap: break-word;
    }

    .message-content pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
    }

    .chat-input {
        display: flex;
        padding: 10px;
        background-color: #fff;
        border-top: 1px solid #ddd;
    }

    .chat-input textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: none;
        height: 60px;
    }

    .chat-input button {
        margin-left: 10px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .chat-input button:hover {
        background-color: #45a049;
    }

    .save-playbook-btn {
        margin: 10px;
        padding: 10px 20px;
        background-color: #2196F3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: none;
    }

    .save-playbook-btn:hover {
        background-color: #0b7dda;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
            <h2 class="card-title">Vulnerabilities</h2>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <form method="get" action="{% url 'vulnerability_list' %}" class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="severity" class="form-label">Severity</label>
                                <select id="severity" name="severity" class="form-control">
                                    <option value="">All</option>
                                    <option value="4" {% if request.GET.severity == '4' %}selected{% endif %}>Critical</option>
                                    <option value="3" {% if request.GET.severity == '3' %}selected{% endif %}>High</option>
                                    <option value="2" {% if request.GET.severity == '2' %}selected{% endif %}>Medium</option>
                                    <option value="1" {% if request.GET.severity == '1' %}selected{% endif %}>Low</option>
                                    <option value="0" {% if request.GET.severity == '0' %}selected{% endif %}>Info</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="search" class="form-label">Search</label>
                                <input type="text" id="search" name="search" class="form-control" value="{{ request.GET.search }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="date_from" class="form-label">Date From</label>
                                <input type="date" id="date_from" name="date_from" class="form-control" value="{{ request.GET.date_from }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="date_to" class="form-label">Date To</label>
                                <input type="date" id="date_to" name="date_to" class="form-control" value="{{ request.GET.date_to }}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-left">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="{% url 'vulnerability_list' %}" class="btn btn-secondary ml-2">Reset</a>
                    </div>
                </div>
            </form>
        </div>

        {% if vulnerabilities %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>CVE</th>
                        <th>Severity</th>
                        <th>Risk Factor</th>
                        <th>CVSS Score</th>
                        <th>True Risk Score</th>
                        <th>Discovered</th>
                        <th>Affected Asset</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in vulnerabilities %}
                    <tr>
                        <td>{{ vuln.name }}</td>
                        <td>{{ vuln.cve }}</td>

                        <td class="severity-{% if vuln.severity == 4 %}critical{% elif vuln.severity == 3 %}high{% elif vuln.severity == 2 %}medium{% elif vuln.severity == 1 %}low{% else %}info{% endif %}">
                            {{ vuln.get_severity_display }}
                        </td>
                        <td>{{ vuln.risk_factor|default:"N/A" }}</td>
                        <td>{{ vuln.cvss_score }}</td>
                        <td>{{ vuln.true_risk_score|floatformat:5|default:"N/A" }}</td>
                        <td>{{ vuln.discovered_date }}</td>
                        <td>{{ vuln.affected_asset }}</td>
                        <td>
                            <a href="{% url 'vulnerability_detail' vuln.id %}" class="btn btn-sm btn-info">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if is_paginated %}
            <div class="pagination">
                <span class="step-links">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; first</a>
                        <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">previous</a>
                    {% endif %}

                    <span class="current">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">next</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
            {% endif %}
        {% else %}
            <p>No vulnerabilities found.</p>
        {% endif %}
    </div>
</div>

<!-- Floating Chat Button -->
<div id="floating-chat-btn" class="floating-chat-btn" title="Chat with AI for CVE remediation">
    <div class="chat-icon"></div>
</div>

<!-- Chat Modal -->
<div id="chat-modal" class="chat-modal">
    <div class="chat-modal-content">
        <div class="chat-modal-header">
            <h3 class="chat-modal-title">CVE Remediation Chat</h3>
            <button id="chat-modal-close" class="chat-modal-close">&times;</button>
        </div>
        <div class="chat-modal-body">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages will be displayed here -->
                    <div class="message assistant-message">
                        <div class="message-content">
                            Hello! I'm your AI assistant for generating Ansible playbooks to remediate CVE vulnerabilities. 
                            Please provide information about the vulnerability you want to remediate. 
                            Include the CVE number if available, the affected systems, and any specific requirements for the playbook.
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <textarea id="message-input" placeholder="Type your message here..."></textarea>
                    <button id="send-button">Send</button>
                </div>
            </div>
            <div style="display: flex;">
                <button id="save-playbook" class="btn btn-success mt-2" style="display: none;">Copy Playbook</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const floatingChatBtn = document.getElementById('floating-chat-btn');
        const chatModal = document.getElementById('chat-modal');
        const chatModalClose = document.getElementById('chat-modal-close');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const savePlaybookButton = document.getElementById('save-playbook');

        let conversationId = '';
        let vulnerabilityId = '';
        let lastPlaybookContent = '';

        // Function to open the chat modal
        function openChatModal(vulnId = '') {
            vulnerabilityId = vulnId;
            conversationId = '';

            // Clear previous messages except the welcome message
            while (chatMessages.children.length > 1) {
                chatMessages.removeChild(chatMessages.lastChild);
            }

            // Update welcome message if we have a vulnerability ID
            if (vulnerabilityId) {
                // We'll fetch the vulnerability details in the first message
                const firstMessage = chatMessages.querySelector('.message-content');
                firstMessage.textContent = "Hello! I\'m your AI assistant for generating Ansible playbooks to remediate CVE vulnerabilities. should always be reviewed by an expert and not run in production without authorization.;"

                // Send an initial message to get vulnerability details
                sendMessage('Please provide details about this vulnerability and how to remediate it.');
            }

            // Show the modal
            chatModal.style.display = 'flex';
            messageInput.focus();
        }

        // Function to close the chat modal
        function closeChatModal() {
            chatModal.style.display = 'none';
            savePlaybookButton.style.display = 'none';
        }

        // Add click event listener to the floating chat button
        floatingChatBtn.addEventListener('click', function() {
            openChatModal();
        });

        // Add click event listener to the modal close button
        chatModalClose.addEventListener('click', closeChatModal);

        // Close modal when clicking outside the content
        chatModal.addEventListener('click', function(event) {
            if (event.target === chatModal) {
                closeChatModal();
            }
        });

        // Add click event listeners to the "View" buttons to enable chat with specific vulnerability
        const viewButtons = document.querySelectorAll('a.btn-info');
        viewButtons.forEach(button => {
            // Create a new chat button next to each "View" button
            const chatButton = document.createElement('a');
            chatButton.className = 'btn btn-sm btn-success ml-1';
            chatButton.textContent = 'Remediate';
            chatButton.title = 'Chat with AI to remediate this vulnerability';

            // Extract vulnerability ID from the "View" button's href
            const viewHref = button.getAttribute('href');
            const vulnerabilityId = viewHref.split('/').filter(Boolean).pop();

            // Set the chat button's click event
            chatButton.addEventListener('click', function(event) {
                event.preventDefault();
                openChatModal(vulnerabilityId);
            });

            // Insert the chat button after the "View" button
            button.parentNode.insertBefore(chatButton, button.nextSibling);
        });

        // Function to add a message to the chat
        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Check if the content contains code blocks and format them
            if (content.includes('```')) {
                const parts = content.split('```');
                let formattedContent = '';

                for (let i = 0; i < parts.length; i++) {
                    if (i % 2 === 0) {
                        // Text outside code blocks
                        formattedContent += parts[i];
                    } else {
                        // Code block
                        const code = parts[i].trim();
                        const language = code.split('\n')[0].trim();
                        const codeContent = language ? code.substring(language.length).trim() : code;

                        formattedContent += `<pre><code>${codeContent}</code></pre>`;

                        // Store the playbook content for saving
                        if (code.includes('yaml') || code.includes('yml')) {
                            lastPlaybookContent = codeContent;
                            savePlaybookButton.style.display = 'block';
                        }
                    }
                }

                contentDiv.innerHTML = formattedContent;
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to the bottom of the chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to send a message to the API
        async function sendMessage(message) {
            try {
                // Add user message to chat if it's not an automatic message
                if (arguments.length === 1) {
                    addMessage(message, true);
                }

                const response = await fetch('/api/cve-chat/api/send-message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId,
                        vulnerability_id: vulnerabilityId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Update conversation ID if it's a new conversation
                    if (!conversationId) {
                        conversationId = data.conversation_id;
                    }

                    // Add the assistant's response to the chat
                    addMessage(data.response, false);
                } else {
                    console.error('Error:', data.error);
                    addMessage('Sorry, there was an error processing your request.', false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, there was an error processing your request.', false);
            }
        }

        // Function to copy playbook to clipboard
        function copyPlaybook() {
            if (!lastPlaybookContent) {
                showCustomAlert('No playbook content to copy.', 'warning');
                return;
            }

            // Try using the Clipboard API first
            navigator.clipboard.writeText(lastPlaybookContent)
                .then(() => {
                    // Provide feedback to the user
                    showCustomAlert('Playbook copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Error copying playbook with Clipboard API: ', err);

                    // Fallback method: Create a temporary textarea element
                    try {
                        const textarea = document.createElement('textarea');
                        textarea.value = lastPlaybookContent;
                        textarea.style.position = 'fixed';  // Make it invisible
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();

                        // Execute copy command
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textarea);

                        if (successful) {
                            showCustomAlert('Playbook copied to clipboard!', 'success');
                        } else {
                            showCustomAlert('Unable to copy playbook. Please try selecting and copying the content manually.', 'danger');
                        }
                    } catch (fallbackErr) {
                        console.error('Fallback copy method failed: ', fallbackErr);
                        showCustomAlert('Unable to copy automatically. Please select and copy the playbook manually.', 'danger');
                    }
                });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Event listener for send button
        sendButton.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (message) {
                messageInput.value = '';
                sendMessage(message);
            }
        });

        // Event listener for Enter key in textarea
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendButton.click();
            }
        });

        // Event listener for copy playbook button
        savePlaybookButton.addEventListener('click', copyPlaybook);
    });
</script>

<script>
    // Custom alert function to replace standard browser alert
    function showCustomAlert(message, type = 'info') {
        // Create alert container
        const alertContainer = document.createElement('div');
        alertContainer.className = 'custom-alert-container';

        // Create alert element
        const alertElement = document.createElement('div');
        alertElement.className = `alert alert-${type} custom-alert`;
        alertElement.textContent = message;

        // Add close button
        const closeButton = document.createElement('button');
        closeButton.className = 'custom-alert-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = function() {
            document.body.removeChild(alertContainer);
        };

        // Append elements
        alertElement.appendChild(closeButton);
        alertContainer.appendChild(alertElement);
        document.body.appendChild(alertContainer);

        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (document.body.contains(alertContainer)) {
                alertContainer.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(alertContainer)) {
                        document.body.removeChild(alertContainer);
                    }
                }, 500);
            }
        }, 3000);
    }

    // Add custom styles for the alert
    const style = document.createElement('style');
    style.textContent = `
        .custom-alert-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.3);
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .custom-alert {
            max-width: 400px;
            margin: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            padding-right: 40px;
            animation: alertFadeIn 0.3s ease-out;
        }

        .custom-alert-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .custom-alert-close:hover {
            opacity: 1;
        }

        @keyframes alertFadeIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
